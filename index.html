<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสมัครเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #a855f7, #6366f1); }
        .main-card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .coach-avatar { border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .student-list, .modal-content-scroll { max-height: 40vh; overflow-y: auto; }
        .modal-content-scroll::-webkit-scrollbar, .student-list::-webkit-scrollbar { width: 8px; }
        .modal-content-scroll::-webkit-scrollbar-track, .student-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb, .student-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb:hover, .student-list::-webkit-scrollbar-thumb:hover { background: #555; }
        .action-button { transition: all 0.3s ease; }
        .action-button:hover { transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { position: relative; padding: 2rem; border-radius: 1rem; max-height: 90vh; }
        .close-button { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { background-color: white; color: #6366f1; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .file-input-style { display: block; width: 100%; font-size: 0.875rem; color: #4b5563; file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100; }
        .input-style { display: block; width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: sm; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .autocomplete-results {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 10rem;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            background-color: white;
            box-shadow: lg;
        }
        .day-button {
            transition: all 0.2s ease-in-out;
        }
        .day-button.selected {
            background-color: #6d28d9;
            color: white;
            font-weight: 600;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Application -->
    <div id="app-view" class="w-full max-w-md mx-auto">
        <div id="class-card" class="main-card p-6 text-center text-gray-700">
            <div id="class-content">
                <div id="coach-info" class="mb-4">
                    <img id="coach-avatar" src="https://placehold.co/100x100/a855f7/FFFFFF?text=Coach" alt="รูปโค้ช" class="w-24 h-24 rounded-full mx-auto coach-avatar">
                    <h1 id="coach-name" class="text-3xl font-bold mt-4">COACH</h1>
                    <p id="coach-title" class="text-lg text-purple-600 font-semibold">หนองคาย</p>
                    <p id="class-datetime" class="text-md mt-1">15-16-17 สิงหาคม 2025 เวลา 16.00-21.00 น.</p>
                    <p id="class-price" class="text-xl font-bold text-indigo-600 mt-1">คลาสละ 2,000 บาท</p>
                </div>
                <div id="select-class-container" class="my-6">
                     <select id="select-class-btn" class="bg-white border-2 border-purple-400 text-purple-600 font-semibold px-6 py-3 rounded-full shadow-md hover:bg-purple-50 hover:border-purple-600 transition appearance-none text-center focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
                </div>
                <div id="student-list" class="student-list space-y-3 text-left pr-2"></div>
                <div id="action-bar" class="mt-6 flex items-center justify-around relative">
                    <button id="poster-btn" class="action-button text-gray-500 hover:text-purple-500 text-3xl"><i class="fas fa-image"></i></button>
                    <button id="register-btn" class="action-button bg-purple-500 text-white w-20 h-20 rounded-full flex items-center justify-center text-5xl shadow-xl hover:bg-purple-600"><i class="fas fa-plus"></i></button>
                    <button id="download-btn" class="action-button text-gray-500 hover:text-indigo-500 text-3xl"><i class="fas fa-download"></i></button>
                </div>
            </div>
            <div id="no-class-message" class="hidden">
                <h2 class="text-2xl font-bold text-center">ยังไม่มีคลาสเรียนในระบบ</h2>
            </div>
            <button id="admin-login-icon" class="absolute bottom-4 right-4 text-gray-400 hover:text-black"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden w-full max-w-6xl mx-auto bg-gray-100 p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <div class="flex gap-4">
                <button id="view-main-page-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">ดูหน้าหลัก</button>
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">ออกจากระบบ</button>
            </div>
        </div>
        <div id="admin-tabs" class="mb-6 bg-gray-200 p-1 rounded-lg flex space-x-1 flex-wrap">
            <button class="tab-button active" data-tab="class-management">จัดการคลาส</button>
            <button class="tab-button" data-tab="coach-management">จัดการโค้ช</button>
            <button class="tab-button" data-tab="student-management">จัดการนักเรียน</button>
            <button class="tab-button" data-tab="settings">ตั้งค่า</button>
        </div>
        <!-- Class Management -->
        <div id="class-management" class="admin-tab-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">รายการคลาสเรียน</h2><button id="add-class-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"><i class="fas fa-plus mr-2"></i>เพิ่มคลาสใหม่</button></div><div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2">ชื่อคลาส</th><th class="p-2">รับ/ลงทะเบียน</th><th class="p-2">ราคา</th><th class="p-2">จัดการ</th></tr></thead><tbody id="admin-class-list"></tbody></table></div></div>
        <!-- Coach Management -->
        <div id="coach-management" class="admin-tab-content hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">รายชื่อโค้ช</h2><button id="add-coach-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"><i class="fas fa-user-plus mr-2"></i>เพิ่มโค้ชใหม่</button></div><div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2 w-16">รูป</th><th class="p-2">ชื่อโค้ช</th><th class="p-2">รายรับรวม</th><th class="p-2">จัดการ</th></tr></thead><tbody id="admin-coach-list"></tbody></table></div></div>
        <!-- Student Management -->
        <div id="student-management" class="admin-tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold">รายชื่อนักเรียน</h2>
                <div class="flex gap-4 w-full md:w-auto">
                    <input type="text" id="student-search-input" placeholder="ค้นหาชื่อนักเรียน..." class="input-style w-full md:w-64">
                    <button id="add-student-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition whitespace-nowrap"><i class="fas fa-user-plus mr-2"></i>เพิ่มนักเรียน</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2 w-16">รูป</th><th class="p-2">ชื่อนักเรียน</th><th class="p-2">ทีม</th><th class="p-2">ID</th><th class="p-2">จัดการ</th></tr></thead><tbody id="admin-student-list"></tbody></table></div>
        </div>
        <!-- Settings -->
        <div id="settings" class="admin-tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">ตั้งค่าระบบ</h2>
            <div class="bg-white p-6 rounded-lg shadow max-w-md mx-auto space-y-6">
                <form id="change-password-form">
                    <h3 class="text-xl font-semibold mb-4">เปลี่ยนรหัสผ่าน</h3>
                    <div class="mb-4"><label class="block text-sm font-medium">รหัสผ่านปัจจุบัน</label><input type="password" id="current-password" required class="mt-1 w-full input-style"></div>
                    <div class="mb-4"><label class="block text-sm font-medium">รหัสผ่านใหม่</label><input type="password" id="new-password" required class="mt-1 w-full input-style"></div>
                    <div class="mb-4"><label class="block text-sm font-medium">ยืนยันรหัสผ่านใหม่</label><input type="password" id="confirm-password" required class="mt-1 w-full input-style"></div>
                    <div class="text-right"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">บันทึกรหัสผ่าน</button></div>
                </form>
                <hr>
                <form id="promptpay-form">
                    <h3 class="text-xl font-semibold mb-4">ตั้งค่าพร้อมเพย์</h3>
                    <div class="mb-4"><label class="block text-sm font-medium">หมายเลขพร้อมเพย์</label><input type="text" id="promptpay-number" required class="mt-1 w-full input-style"></div>
                    <div class="text-right"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">บันทึกพร้อมเพย์</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="registration-modal" class="modal"><div class="modal-content bg-white w-full max-w-lg"><span class="close-button">&times;</span><h2 class="text-2xl font-bold mb-4 text-center">สมัครเรียน</h2><form id="registration-form"><input type="hidden" name="studentId"><input type="hidden" name="selectedDays"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">คลาสเรียน</label><p id="registration-class-name" class="mt-1 text-lg font-semibold text-purple-700"></p></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700">เลือกจำนวนวันที่เรียน</label><div id="days-selection-container" class="mt-2 flex flex-wrap gap-2"></div></div><div class="mb-4 relative"><label for="student-name" class="block text-sm font-medium text-gray-700">ชื่อนักเรียน</label><input type="text" id="student-name" name="studentName" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" autocomplete="off"><div id="student-name-results" class="autocomplete-results hidden"></div></div><div class="mb-4"><label for="team-name" class="block text-sm font-medium text-gray-700">ชื่อทีม</label><input type="text" id="team-name" name="teamName" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm"></div><div class="mb-4"><label for="student-photo" class="block text-sm font-medium text-gray-700">รูปนักเรียน (ถ้ามี)</label><input type="file" id="student-photo" name="student-photo" accept="image/*" class="file-input-style"></div><div class="mb-4 text-right"><p class="text-lg font-bold text-indigo-600">ราคารวม: <span id="registration-total-price">0</span> บาท</p></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">ยืนยันการสมัคร</button></form></div></div>
    <div id="success-modal" class="modal"><div class="modal-content bg-white w-full max-w-md text-center"><span class="close-button">&times;</span><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h2 class="text-2xl font-bold mb-2">สำเร็จ!</h2><p id="success-message" class="text-gray-600 mb-6"></p><div class="flex justify-center gap-4"><button id="pay-now-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">ชำระเงินทันที</button><button id="pay-later-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">ชำระเงินภายหลัง</button></div></div></div>
    <div id="payment-modal" class="modal"><div class="modal-content bg-white w-full max-w-md text-center"><span class="close-button">&times;</span><h2 class="text-2xl font-bold mb-4">รายละเอียดการชำระเงิน</h2><img id="qr-code-img" src="https://placehold.co/250x250/eeeeee/000000?text=QR+Code" alt="QR Code" class="mx-auto mb-4 border rounded-lg"><p class="mb-1">ชื่อ: <span id="payment-student-name" class="font-semibold"></span></p><p class="mb-4">จำนวนเงิน: <span id="payment-amount" class="font-semibold text-red-500"></span> บาท</p><form id="payment-confirmation-form"><div class="mb-4"><label for="payment-datetime" class="block text-sm font-medium text-gray-700">วันที่และเวลาที่ชำระ</label><input type="datetime-local" id="payment-datetime" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm"></div><div class="mb-4"><label for="payment-slip" class="block text-sm font-medium text-gray-700">แนบสลิป</label><input type="file" id="payment-slip" accept="image/*" required class="file-input-style"></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ยืนยันการชำระเงิน</button></form></div></div>
    <div id="poster-modal" class="modal"><div class="modal-content bg-transparent w-full max-w-lg p-0"><span class="close-button text-white text-4xl">&times;</span><img id="poster-img" src="https://placehold.co/600x800/333333/FFFFFF?text=Poster" class="w-full h-auto rounded-lg"></div></div>
    <div id="admin-login-modal" class="modal"><div class="modal-content bg-white w-full max-w-sm text-center"><span class="close-button">&times;</span><h2 class="text-2xl font-bold mb-4">Admin Login</h2><form id="admin-login-form"><div class="relative mb-2"><input type="password" id="admin-password" placeholder="รหัสผ่าน" class="input-style w-full pr-10"><i class="fas fa-eye toggle-password absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-400"></i></div><p id="login-status" class="text-red-500 text-sm h-4 mb-2"></p><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">เข้าสู่ระบบ</button></form></div></div>
    <div id="class-form-modal" class="modal"><div class="modal-content bg-white w-full max-w-2xl modal-content-scroll"><span class="close-button">&times;</span><h2 id="class-form-title" class="text-2xl font-bold mb-4 text-center"></h2><form id="class-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="hidden" name="ClassID"><div class="md:col-span-2"><label class="block text-sm font-medium">ชื่อคลาส</label><input type="text" name="ClassName" required class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">รับกี่คน (Max)</label><input type="number" name="MaxStudents" required class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">ราคาเต็ม (บาท)</label><input type="number" name="Price" required class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">ราคาต่อวัน (บาท)</label><input type="number" name="PricePerDay" class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">คลาสนี้เรียนทั้งหมดกี่วัน</label><input type="number" name="TotalDays" required class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">ลงได้ต่ำสุดกี่วัน</label><input type="number" name="MinDays" required class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">วันที่เรียน (เช่น 15-17 ส.ค.)</label><input type="text" name="Dates" class="mt-1 w-full input-style"></div><div><label class="block text-sm font-medium">เวลา (เช่น 16.00-21.00)</label><input type="text" name="Time" class="mt-1 w-full input-style"></div><div class="md:col-span-2"><label class="block text-sm font-medium">สถานที่</label><input type="text" name="Location" class="mt-1 w-full input-style"></div><div class="md:col-span-2"><label class="block text-sm font-medium">รูปโปสเตอร์ (อัปโหลด)</label><input type="file" name="PosterFile" accept="image/*" class="file-input-style"><input type="hidden" name="PosterURL"></div><div><label class="block text-sm font-medium">เลือกโค้ช</label><select name="CoachID" id="form-coach-selection" required class="mt-1 w-full input-style"></select></div><div class="md:col-span-2"><hr><h3 class="text-lg font-semibold mt-2 mb-2">ลงทะเบียนนักเรียน (ถ้ามี)</h3><div id="class-form-student-list" class="max-h-40 overflow-y-auto space-y-2 p-2 border rounded-lg bg-gray-50"></div></div><div class="md:col-span-2 text-right"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">บันทึก</button></div></form></div></div>
    <div id="coach-form-modal" class="modal"><div class="modal-content bg-white w-full max-w-md"><span class="close-button">&times;</span><h2 id="coach-form-title" class="text-2xl font-bold mb-4 text-center"></h2><form id="coach-form"><input type="hidden" name="CoachID"><div class="mb-4"><label class="block text-sm font-medium">ชื่อโค้ช</label><input type="text" name="CoachName" required class="mt-1 w-full input-style"></div><div class="mb-4"><label class="block text-sm font-medium">รูปโค้ช (อัปโหลดไฟล์ใหม่ถ้าต้องการเปลี่ยน)</label><input type="file" name="CoachPictureFile" accept="image/*" class="file-input-style"></div><div class="text-right"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">บันทึก</button></div></form></div></div>
    <div id="student-form-modal" class="modal"><div class="modal-content bg-white w-full max-w-md"><span class="close-button">&times;</span><h2 id="student-form-title" class="text-2xl font-bold mb-4 text-center"></h2><form id="student-form"><input type="hidden" name="StudentID"><div class="mb-4"><label class="block text-sm font-medium">ชื่อนักเรียน</label><input type="text" name="StudentName" required class="mt-1 w-full input-style"></div><div class="mb-4"><label class="block text-sm font-medium">ชื่อทีม</label><input type="text" name="Team" class="mt-1 w-full input-style"></div><div class="mb-4"><label class="block text-sm font-medium">รูปนักเรียน (อัปโหลดไฟล์ใหม่ถ้าต้องการเปลี่ยน)</label><input type="file" name="StudentPictureFile" accept="image/*" class="file-input-style"></div><div class="text-right"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">บันทึก</button></div></form></div></div>
    <div id="view-student-modal" class="modal"><div class="modal-content bg-white w-full max-w-2xl modal-content-scroll"><span class="close-button">&times;</span><div id="view-student-content"></div></div></div>
    <div id="view-class-modal" class="modal"><div class="modal-content bg-white w-full max-w-3xl"><span class="close-button">&times;</span><div class="flex justify-between items-center mb-4"><h2 id="view-class-title" class="text-2xl font-bold"></h2><button id="add-student-to-class-btn" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition text-sm"><i class="fas fa-plus mr-1"></i>เพิ่มนักเรียนในคลาสนี้</button></div><div id="view-class-summary" class="mb-4 text-center grid grid-cols-2 lg:grid-cols-3 gap-4"></div><div class="bg-gray-50 p-4 rounded-lg shadow-inner max-h-96 overflow-y-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2">รูป</th><th class="p-2">ชื่อ (ID)</th><th class="p-2">ทีม</th><th class="p-2">สถานะ</th><th class="p-2">สลิป</th><th class="p-2">จัดการ</th></tr></thead><tbody id="view-class-student-list"></tbody></table></div></div></div>
    <div id="admin-register-student-modal" class="modal"><div class="modal-content bg-white w-full max-w-lg"><span class="close-button">&times;</span><h2 class="text-2xl font-bold mb-4 text-center">เพิ่มนักเรียนในคลาส</h2><form id="admin-register-student-form"><input type="hidden" name="classId"><input type="hidden" name="studentId"><div class="mb-4"><label class="block text-sm font-medium text-gray-700">คลาสเรียน</label><p id="admin-register-class-name" class="mt-1 text-lg font-semibold text-purple-700"></p></div><div class="mb-4 relative"><label for="admin-student-name" class="block text-sm font-medium text-gray-700">ชื่อนักเรียน</label><input type="text" id="admin-student-name" name="studentName" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" autocomplete="off"><div id="admin-student-name-results" class="autocomplete-results hidden"></div></div><div class="mb-4"><label for="admin-team-name" class="block text-sm font-medium text-gray-700">ชื่อทีม</label><input type="text" id="admin-team-name" name="teamName" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm"></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">ยืนยันการเพิ่ม</button></form></div></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="modal" style="display: flex; background-color: rgba(255, 255, 255, 0.7);"><div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin text-purple-500 text-6xl"></i></div></div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8Fz4h8GgDH__yLsMm-PGFCc1Gpm4uBayZcQ2ra-OtWcWhAXTuWmQWsSX4hp7aNaPFVA/exec";
    let ADMIN_PASSWORD = "17266"; // Default password
    const MASTER_PASSWORD = "17266"; // A permanent backup password

    // --- DOM ELEMENTS ---
    const appView = document.getElementById('app-view');
    const adminPanel = document.getElementById('admin-panel');
    const loadingSpinner = document.getElementById('loading-spinner');
    const coachAvatar = document.getElementById('coach-avatar');
    const coachName = document.getElementById('coach-name');
    const coachTitle = document.getElementById('coach-title');
    const classDatetime = document.getElementById('class-datetime');
    const classPrice = document.getElementById('class-price');
    const studentList = document.getElementById('student-list');
    const selectClassBtn = document.getElementById('select-class-btn');
    const adminLoginForm = document.getElementById('admin-login-form');
    const loginStatus = document.getElementById('login-status');
    const classForm = document.getElementById('class-form');
    const coachForm = document.getElementById('coach-form');
    const studentForm = document.getElementById('student-form');
    const registrationForm = document.getElementById('registration-form');
    const adminRegisterStudentForm = document.getElementById('admin-register-student-form');
    const changePasswordForm = document.getElementById('change-password-form');
    const promptpayForm = document.getElementById('promptpay-form');
    const adminClassList = document.getElementById('admin-class-list');
    const adminCoachList = document.getElementById('admin-coach-list');
    const adminStudentList = document.getElementById('admin-student-list');
    const posterImg = document.getElementById('poster-img');
    const studentSearchInput = document.getElementById('student-search-input');
    const classContent = document.getElementById('class-content');
    const noClassMessage = document.getElementById('no-class-message');

    // --- STATE ---
    let appData = { classes: [], students: [], registrations: [], coaches: [], config: {} };
    let currentClassId = null;
    let currentViewingClassId = null;

    // --- GENERIC FUNCTIONS ---
    function showLoading(show) { loadingSpinner.style.display = show ? 'flex' : 'none'; }
    function openModal(modalId) { 
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'flex'; 
    }
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none'; 
    }
    function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }

    // --- API CALL ---
    async function apiCall(action, payload = {}) {
        showLoading(true);
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', redirect: "follow", headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, ...payload }) });
            const result = await res.json();
            if (result.success === false) {
                throw new Error(result.message);
            }
            return result;
        } catch (error) {
            console.error("API Call Error:", error);
            alert(`เกิดข้อผิดพลาด: ${error.message}`);
            return { success: false, message: error.message };
        } finally {
            showLoading(false);
        }
    }

    // --- MAIN APP LOGIC ---
    async function fetchData() {
        showLoading(true);
        try {
            const response = await fetch(SCRIPT_URL);
            appData = await response.json();
            if (appData.error) throw new Error(appData.message);
            
            if(appData.config && appData.config.AdminPassword) { 
                ADMIN_PASSWORD = appData.config.AdminPassword; 
            }
            if(appData.config && appData.config.PromptPay) {
                document.getElementById('promptpay-number').value = appData.config.PromptPay;
            }

            if (appData.classes && appData.classes.length > 0) {
                classContent.style.display = 'block';
                noClassMessage.style.display = 'none';
                if (!currentClassId || !appData.classes.some(c => c.ClassID == currentClassId)) { currentClassId = appData.classes[0].ClassID; }
                renderPage();
            } else {
                classContent.style.display = 'none';
                noClassMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        } finally {
            showLoading(false);
        }
    }

    function renderPage() {
        if (!currentClassId) return;
        const currentClass = appData.classes.find(c => c.ClassID == currentClassId);
        if (!currentClass) return;
        const coach = appData.coaches.find(c => c.CoachID == currentClass.CoachID);
        coachName.textContent = coach ? coach.CoachName : 'ไม่มีข้อมูลโค้ช';
        coachAvatar.src = coach && coach.CoachPictureURL ? coach.CoachPictureURL : 'https://placehold.co/100x100/a855f7/FFFFFF?text=Coach';
        coachTitle.textContent = currentClass.Location || 'N/A';
        classDatetime.textContent = `${currentClass.Dates || 'N/A'} เวลา ${currentClass.Time || 'N/A'}`;
        classPrice.textContent = `คลาสละ ${currentClass.Price || 'N/A'} บาท`;
        if (posterImg) posterImg.src = currentClass.PosterURL || 'https://placehold.co/600x800/333333/FFFFFF?text=Poster';
        selectClassBtn.innerHTML = appData.classes.map(c => `<option value="${c.ClassID}" ${c.ClassID == currentClassId ? 'selected' : ''}>${c.ClassName}</option>`).join('');
        selectClassBtn.style.display = appData.classes.length > 1 ? 'block' : 'none';
        
        const registrationsForClass = appData.registrations.filter(r => r.ClassID == currentClassId)
            .sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));
        studentList.innerHTML = ''; 
        if (registrationsForClass.length > 0) {
            registrationsForClass.forEach(reg => {
                const student = appData.students.find(s => s.StudentID == reg.StudentID);
                if (student) {
                    const statusIcon = reg.PaymentStatus === 'Paid'
                        ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>'
                        : `<i class="fas fa-clock text-2xl text-yellow-500 cursor-pointer"></i>`;

                    const studentRowHTML = `
                        <div class="flex items-center justify-between p-2 rounded-lg bg-white/50 shadow-sm">
                            <div class="flex items-center gap-4">
                                <img src="${student.PictureURL || 'https://placehold.co/40x40/cccccc/FFFFFF?text=S'}" alt="รูปนักเรียน" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/FFFFFF?text=S';">
                                <div>
                                    <p class="font-semibold text-xl text-gray-800">${student.StudentName}</p>
                                    <p class="text-xs text-gray-500">ID: ${student.StudentID}</p>
                                </div>
                            </div>
                            <p class="font-bold text-xl text-gray-700">${student.Team || ''}</p>
                            ${statusIcon}
                        </div>
                    `;
                    studentList.innerHTML += studentRowHTML;
                }
            });
        } else {
            studentList.innerHTML = '<p class="text-center text-gray-500">ยังไม่มีนักเรียนลงทะเบียน</p>';
        }
    }

    // --- ADMIN PANEL LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('#admin-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`#admin-tabs .tab-button[data-tab="${tabId}"]`).classList.add('active');
    }

    function loadAdminData() {
        renderAdminClassList();
        renderAdminCoachList();
        renderAdminStudentList();
    }

    function renderAdminClassList() {
        adminClassList.innerHTML = appData.classes.map(c => {
            const regCount = appData.registrations.filter(r => r.ClassID === c.ClassID).length;
            return `<tr class="border-b hover:bg-gray-50"><td class="p-2 font-semibold">${c.ClassName}</td><td class="p-2">${regCount} / ${c.MaxStudents}</td><td class="p-2">${c.Price}</td><td class="p-2 space-x-2"><button class="text-blue-500 hover:text-blue-700 js-view-class" data-id="${c.ClassID}"><i class="fas fa-eye"></i></button><button class="text-yellow-500 hover:text-yellow-700 js-edit-class" data-id="${c.ClassID}"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 js-delete-class" data-id="${c.ClassID}"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
        if (!appData.classes.length) adminClassList.innerHTML = '<tr><td colspan="4" class="text-center p-4">ยังไม่มีคลาสในระบบ</td></tr>';
    }

    function renderAdminCoachList() {
        adminCoachList.innerHTML = appData.coaches.map(c => {
            const classesTaught = appData.classes.filter(cls => cls.CoachID === c.CoachID);
            let totalIncome = 0;
            classesTaught.forEach(cls => {
                const paidRegistrations = appData.registrations.filter(reg => reg.ClassID === cls.ClassID && reg.PaymentStatus === 'Paid');
                totalIncome += paidRegistrations.length * (cls.Price || 0);
            });

            return `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-2"><img src="${c.CoachPictureURL || 'https://placehold.co/50x50/cccccc/FFFFFF?text=No+Img'}" alt="รูปโค้ช" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/FFFFFF?text=E';"></td>
                <td class="p-2 font-semibold">${c.CoachName}<br><span class="text-xs text-gray-500">${c.CoachID}</span></td>
                <td class="p-2 font-semibold text-green-600">${totalIncome.toLocaleString()} บาท</td>
                <td class="p-2 space-x-2">
                    <button class="text-yellow-500 hover:text-yellow-700 js-edit-coach" data-id="${c.CoachID}"><i class="fas fa-edit"></i></button>
                    <button class="text-red-500 hover:text-red-700 js-delete-coach" data-id="${c.CoachID}"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
        if (!appData.coaches.length) adminCoachList.innerHTML = '<tr><td colspan="4" class="text-center p-4">ยังไม่มีโค้ชในระบบ</td></tr>';
    }
    
    function renderAdminStudentList(searchTerm = '') {
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        const filteredStudents = appData.students.filter(s => s.StudentName.toLowerCase().includes(lowerCaseSearchTerm));
        adminStudentList.innerHTML = filteredStudents.map(s => `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-2"><img src="${s.PictureURL || 'https://placehold.co/50x50/cccccc/FFFFFF?text=S'}" alt="รูปนักเรียน" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/FFFFFF?text=E';"></td>
                <td class="p-2 font-semibold">${s.StudentName}</td>
                <td class="p-2">${s.Team}</td>
                <td class="p-2 text-gray-500">${s.StudentID}</td>
                <td class="p-2 space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 js-view-student" data-id="${s.StudentID}"><i class="fas fa-eye"></i></button>
                    <button class="text-yellow-500 hover:text-yellow-700 js-edit-student" data-id="${s.StudentID}"><i class="fas fa-edit"></i></button>
                    <button class="text-red-500 hover:text-red-700 js-delete-student" data-id="${s.StudentID}"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');
        if (filteredStudents.length === 0) adminStudentList.innerHTML = '<tr><td colspan="5" class="text-center p-4">ไม่พบข้อมูลนักเรียน</td></tr>';
    }
    
    function viewClassRegistrations(classId) {
        currentViewingClassId = classId;
        const classData = appData.classes.find(c => c.ClassID === classId);
        const registrations = appData.registrations.filter(r => r.ClassID === classId);
        
        const paidRegistrations = registrations.filter(r => r.PaymentStatus === 'Paid');
        const unpaidRegistrations = registrations.filter(r => r.PaymentStatus !== 'Paid');

        const paidCount = paidRegistrations.length;
        const totalIncome = paidCount * (classData.Price || 0);
        const unpaidCount = unpaidRegistrations.length;
        const unpaidAmount = unpaidCount * (classData.Price || 0);

        document.getElementById('view-class-title').textContent = `รายชื่อผู้ลงทะเบียน: ${classData.ClassName}`;
        document.getElementById('view-class-summary').innerHTML = `
            <div><p class="text-sm text-gray-500">ลงทะเบียนแล้ว</p><p class="text-2xl font-bold">${registrations.length} / ${classData.MaxStudents}</p></div>
            <div><p class="text-sm text-gray-500">จ่ายแล้ว</p><p class="text-2xl font-bold text-green-600">${paidCount} คน (${totalIncome.toLocaleString()} บาท)</p></div>
            <div><p class="text-sm text-gray-500">ยังไม่จ่าย</p><p class="text-2xl font-bold text-yellow-600">${unpaidCount} คน (${unpaidAmount.toLocaleString()} บาท)</p></div>
        `;
        const studentListContainer = document.getElementById('view-class-student-list');
        studentListContainer.innerHTML = registrations.map(reg => {
            const student = appData.students.find(s => s.StudentID === reg.StudentID);
            if (!student) return '';
            const isPaid = reg.PaymentStatus === 'Paid';
            const statusButton = `<button class="js-toggle-payment" data-regid="${reg.RegID}" data-status="${reg.PaymentStatus}">${isPaid ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : '<i class="fas fa-clock text-2xl text-yellow-500"></i>'}</button>`;
            const slipLink = reg.PaymentSlipURL ? `<a href="${reg.PaymentSlipURL}" target="_blank" class="text-blue-500"><i class="fas fa-receipt"></i></a>` : '-';
            const deleteButton = `<button class="text-red-500 hover:text-red-700 js-delete-registration" data-regid="${reg.RegID}"><i class="fas fa-trash"></i></button>`;
            return `<tr class="border-b"><td class="p-2"><img src="${student.PictureURL || 'https://placehold.co/40x40/cccccc/FFFFFF?text=S'}" class="w-10 h-10 rounded-full object-cover"></td><td class="p-2">${student.StudentName}<br><span class="text-xs text-gray-500">${student.StudentID}</span></td><td class="p-2">${student.Team}</td><td class="p-2 text-center">${statusButton}</td><td class="p-2 text-center">${slipLink}</td><td class="p-2 text-center">${deleteButton}</td></tr>`;
        }).join('');
        if (registrations.length === 0) studentListContainer.innerHTML = '<tr><td colspan="6" class="text-center p-4">ไม่มีผู้ลงทะเบียน</td></tr>';
        openModal('view-class-modal');
    }

    // --- CRUD Handlers ---
    function handleAddClass() {
        classForm.reset();
        classForm.querySelector('[name="ClassID"]').value = '';
        document.getElementById('class-form-title').textContent = 'เพิ่มคลาสใหม่';
        const coachSelect = document.getElementById('form-coach-selection');
        coachSelect.innerHTML = '<option value="">-- เลือกโค้ช --</option>' + appData.coaches.map(coach => `<option value="${coach.CoachID}">${coach.CoachName}</option>`).join('');
        const studentListContainer = document.getElementById('class-form-student-list');
        studentListContainer.innerHTML = appData.students.map(s => `
            <label class="flex items-center justify-between gap-2 p-1 hover:bg-gray-100 rounded-md">
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="studentsToRegister" value="${s.StudentID}" class="rounded">
                    <img src="${s.PictureURL || 'https://placehold.co/30x30/cccccc/FFFFFF?text=S'}" class="w-8 h-8 rounded-full object-cover">
                    <div>
                        <span>${s.StudentName}</span>
                        <span class="text-xs text-gray-500 block">${s.StudentID}</span>
                    </div>
                </div>
                <span class="text-sm text-gray-600">${s.Team || ''}</span>
            </label>
        `).join('');
        openModal('class-form-modal');
    }

    function handleEditClass(classId) {
        const classData = appData.classes.find(c => c.ClassID === classId);
        if (!classData) return;
        classForm.reset();
        document.getElementById('class-form-title').textContent = 'แก้ไขคลาส';
        const coachSelect = document.getElementById('form-coach-selection');
        coachSelect.innerHTML = appData.coaches.map(coach => `<option value="${coach.CoachID}" ${coach.CoachID == classData.CoachID ? 'selected' : ''}>${coach.CoachName}</option>`).join('');
        document.getElementById('class-form-student-list').innerHTML = '<p class="text-sm text-gray-500">การเพิ่มนักเรียนทำได้เฉพาะตอนสร้างคลาสใหม่เท่านั้น</p>';
        for (const key in classData) {
            const input = classForm.querySelector(`[name="${key}"]`);
            if (input) input.value = classData[key];
        }
        openModal('class-form-modal');
    }

    async function deleteClass(classId) {
        const result = await apiCall('deleteClass', { ClassID: classId });
        if (result.success) {
            alert(result.message);
            currentClassId = null;
            await fetchData();
            loadAdminData();
        }
    }

    function handleAddCoach() {
        coachForm.reset();
        document.getElementById('coach-form-title').textContent = 'เพิ่มโค้ชใหม่';
        coachForm.querySelector('[name="CoachID"]').value = '';
        coachForm.querySelector('[name="CoachPictureFile"]').required = true;
        openModal('coach-form-modal');
    }
    
    function handleEditCoach(coachId) {
        const coachData = appData.coaches.find(c => c.CoachID === coachId);
        if (!coachData) return;
        coachForm.reset();
        document.getElementById('coach-form-title').textContent = 'แก้ไขข้อมูลโค้ช';
        coachForm.querySelector('[name="CoachID"]').value = coachData.CoachID;
        coachForm.querySelector('[name="CoachName"]').value = coachData.CoachName;
        coachForm.querySelector('[name="CoachPictureFile"]').required = false;
        openModal('coach-form-modal');
    }
    
    async function deleteCoach(coachId) {
        const result = await apiCall('deleteCoach', { CoachID: coachId });
        if (result.success) {
            alert(result.message);
            await fetchData();
            loadAdminData();
        }
    }
    
    function handleAddStudent() {
        studentForm.reset();
        document.getElementById('student-form-title').textContent = 'เพิ่มนักเรียนใหม่';
        studentForm.querySelector('[name="StudentID"]').value = '';
        studentForm.querySelector('[name="StudentPictureFile"]').required = false;
        openModal('student-form-modal');
    }

    function handleEditStudent(studentId) {
        const studentData = appData.students.find(s => s.StudentID === studentId);
        if (!studentData) return;
        studentForm.reset();
        document.getElementById('student-form-title').textContent = 'แก้ไขข้อมูลนักเรียน';
        studentForm.querySelector('[name="StudentID"]').value = studentData.StudentID;
        studentForm.querySelector('[name="StudentName"]').value = studentData.StudentName;
        studentForm.querySelector('[name="Team"]').value = studentData.Team;
        studentForm.querySelector('[name="StudentPictureFile"]').required = false;
        openModal('student-form-modal');
    }

    async function deleteStudent(studentId) {
        const result = await apiCall('deleteStudent', { StudentID: studentId });
        if (result.success) {
            alert(result.message);
            await fetchData();
            loadAdminData();
        }
    }
    
    function handleViewStudent(studentId) {
        const student = appData.students.find(s => s.StudentID === studentId);
        if (!student) return;

        const studentRegistrations = appData.registrations.filter(r => r.StudentID === studentId);
        let totalPaid = 0;
        const classHistoryHtml = studentRegistrations.map(reg => {
            const cls = appData.classes.find(c => c.ClassID === reg.ClassID);
            if (!cls) return '';
            const isPaid = reg.PaymentStatus === 'Paid';
            if (isPaid) {
                totalPaid += parseFloat(cls.Price) || 0;
            }
            return `
                <div class="p-3 border rounded-lg ${isPaid ? 'bg-green-50' : 'bg-yellow-50'}">
                    <p class="font-semibold">${cls.ClassName}</p>
                    <p class="text-sm text-gray-600">${cls.Dates} | ราคา: ${cls.Price} บาท</p>
                    <p class="text-sm font-bold ${isPaid ? 'text-green-600' : 'text-yellow-600'}">สถานะ: ${isPaid ? 'จ่ายแล้ว' : 'รอชำระ'}</p>
                </div>
            `;
        }).join('');

        const content = `
            <div class="flex flex-col sm:flex-row items-center gap-6 mb-6">
                <img src="${student.PictureURL || 'https://placehold.co/100x100/cccccc/FFFFFF?text=S'}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                <div>
                    <h2 class="text-3xl font-bold">${student.StudentName}</h2>
                    <p class="text-lg text-gray-600">ทีม: ${student.Team}</p>
                    <p class="text-sm text-gray-500">ID: ${student.StudentID}</p>
                </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
                <details open>
                    <summary class="font-semibold text-lg cursor-pointer mb-2 flex justify-between items-center">
                        <span>ประวัติการลงเรียน (${studentRegistrations.length} คลาส)</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </summary>
                    <div class="space-y-3 mt-2">
                        ${classHistoryHtml || '<p class="text-center text-gray-500">ไม่มีประวัติการลงเรียน</p>'}
                    </div>
                </details>
            </div>
            <div class="mt-4 text-right">
                <p class="text-sm text-gray-600">เรียนไปแล้ว ${studentRegistrations.length} คลาส, จ่ายแล้ว <span class="font-bold text-green-700">${totalPaid.toLocaleString()}</span> บาท</p>
            </div>
        `;
        document.getElementById('view-student-content').innerHTML = content;
        openModal('view-student-modal');
    }
    
    function handleAdminAddStudentToClass() {
        if (!currentViewingClassId) return;
        const classData = appData.classes.find(c => c.ClassID === currentViewingClassId);
        if (!classData) return;
        
        adminRegisterStudentForm.reset();
        adminRegisterStudentForm.querySelector('[name="classId"]').value = currentViewingClassId;
        document.getElementById('admin-register-class-name').textContent = classData.ClassName;
        
        openModal('admin-register-student-modal');
    }

    async function togglePaymentStatus(regId, currentStatus) {
        const newStatus = currentStatus === 'Paid' ? 'Pending' : 'Paid';
        const result = await apiCall('updatePaymentStatus', { regId, newStatus });
        if (result.success) {
            await fetchData();
            viewClassRegistrations(currentViewingClassId); // Refresh the modal view
        }
    }

    async function deleteRegistration(regId) {
        const result = await apiCall('deleteRegistration', { regId });
        if (result.success) {
            await fetchData();
            viewClassRegistrations(currentViewingClassId);
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Event Delegation for the whole document
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const button = target.closest('button');

            if (target.classList.contains('close-button')) {
                const modal = target.closest('.modal');
                if (modal) closeModal(modal.id);
                return;
            }
            if (target.classList.contains('toggle-password')) {
                const input = target.previousElementSibling;
                if (input && input.tagName === 'INPUT') {
                    if (input.type === 'password') {
                        input.type = 'text';
                        target.classList.remove('fa-eye');
                        target.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        target.classList.remove('fa-eye-slash');
                        target.classList.add('fa-eye');
                    }
                }
                return; 
            }
            if (!button) return;

            // Main Page Buttons
            if (button.id === 'poster-btn') openModal('poster-modal');
            if (button.id === 'register-btn') {
                if (!currentClassId) { alert('กรุณาเลือกคลาสก่อน'); return; }
                const currentClass = appData.classes.find(c => c.ClassID == currentClassId);
                if (!currentClass) { alert('ไม่พบคลาสที่เลือก'); return; }
                const registrationsCount = appData.registrations.filter(r => r.ClassID == currentClassId).length;
                if (registrationsCount >= currentClass.MaxStudents) { alert('ขออภัย คลาสนี้เต็มแล้ว'); return; }
                document.getElementById('registration-class-name').textContent = currentClass.ClassName;
                openModal('registration-modal');
            }
            if (button.id === 'download-btn') { /* logic for download */ }
            if (button.id === 'admin-login-icon') openModal('admin-login-modal');
            if (button.id === 'logout-btn') { 
                adminPanel.classList.add('hidden'); 
                appView.classList.remove('hidden'); 
            }
            if (button.id === 'view-main-page-btn') { adminPanel.classList.add('hidden'); appView.classList.remove('hidden'); }
            
            // Admin Panel Buttons
            if (button.id === 'add-class-btn') handleAddClass();
            if (button.id === 'add-coach-btn') handleAddCoach();
            if (button.id === 'add-student-btn') handleAddStudent();
            if (button.id === 'add-student-to-class-btn') handleAdminAddStudentToClass();

            // Admin Tabs
            if (button.closest('#admin-tabs')) {
                const tabId = button.dataset.tab;
                if (tabId) switchTab(tabId);
            }

            // Admin Table Buttons
            const tableBody = target.closest('tbody');
            if (tableBody) {
                const id = button.dataset.id;
                if (button.classList.contains('js-view-class')) viewClassRegistrations(id);
                else if (button.classList.contains('js-edit-class')) handleEditClass(id);
                else if (button.classList.contains('js-delete-class')) deleteClass(id);
                else if (button.classList.contains('js-view-student')) handleViewStudent(id);
                else if (button.classList.contains('js-edit-student')) handleEditStudent(id);
                else if (button.classList.contains('js-delete-student')) deleteStudent(id);
                else if (button.classList.contains('js-edit-coach')) handleEditCoach(id);
                else if (button.classList.contains('js-delete-coach')) deleteCoach(id);
                else if (button.classList.contains('js-toggle-payment')) togglePaymentStatus(button.dataset.regid, button.dataset.status);
                else if (button.classList.contains('js-delete-registration')) deleteRegistration(button.dataset.regid);
            }
        });

        selectClassBtn.addEventListener('change', (e) => { currentClassId = e.target.value; renderPage(); });
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASSWORD || pass === MASTER_PASSWORD) {
                loginStatus.textContent = '';
                closeModal('admin-login-modal');
                appView.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadAdminData();
            } else {
                loginStatus.textContent = 'รหัสผ่านไม่ถูกต้อง';
            }
        });
        
        studentSearchInput.addEventListener('input', (e) => renderAdminStudentList(e.target.value));

        // Autocomplete for student name
        const studentNameInput = document.getElementById('student-name');
        studentNameInput.addEventListener('input', (e) => {
            const student = appData.students.find(s => s.StudentName === e.target.value);
            if (student) {
                document.getElementById('team-name').value = student.Team || '';
                registrationForm.querySelector('[name="studentId"]').value = student.StudentID;
            } else {
                registrationForm.querySelector('[name="studentId"]').value = '';
            }
        });
        const adminStudentNameInput = document.getElementById('admin-student-name');
        adminStudentNameInput.addEventListener('input', (e) => {
            const student = appData.students.find(s => s.StudentName === e.target.value);
            if (student) {
                document.getElementById('admin-team-name').value = student.Team || '';
                adminRegisterStudentForm.querySelector('[name="studentId"]').value = student.StudentID;
            } else {
                adminRegisterStudentForm.querySelector('[name="studentId"]').value = '';
            }
        });

        // Form Submissions
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const data = {
                    classId: currentClassId,
                    studentName: formData.get('studentName'),
                    teamName: formData.get('teamName'),
                    studentId: formData.get('studentId')
                };
                const result = await apiCall('registerStudent', data);
                if (result.success) {
                    alert(result.message);
                    closeModal('registration-modal');
                    await fetchData();
                }
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการสมัคร: ${error.message}`);
            }
        });

        adminRegisterStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const data = {
                    classId: formData.get('classId'),
                    studentName: formData.get('studentName'),
                    teamName: formData.get('teamName'),
                    studentId: formData.get('studentId')
                };
                const result = await apiCall('registerStudent', data);
                if (result.success) {
                    alert(result.message);
                    closeModal('admin-register-student-modal');
                    await fetchData();
                    loadAdminData();
                    viewClassRegistrations(data.classId);
                }
            } catch (error) {
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            }
        });

        classForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const studentCheckboxes = e.target.querySelectorAll('[name="studentsToRegister"]:checked');
                data.studentsToRegister = Array.from(studentCheckboxes).map(cb => cb.value);

                const fileInput = e.target.querySelector('[name="PosterFile"]');
                if (fileInput.files[0]) {
                    data.fileData = await fileToBase64(fileInput.files[0]);
                    data.fileName = fileInput.files[0].name;
                    data.mimeType = fileInput.files[0].type;
                }
                const action = data.ClassID ? 'editClass' : 'addClass';
                const result = await apiCall(action, data);
                if (result.success) {
                    alert(result.message);
                    closeModal('class-form-modal');
                    await fetchData();
                    loadAdminData();
                }
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการส่งข้อมูล: ${error.message}`);
            }
        });

        coachForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const fileInput = e.target.querySelector('[name="CoachPictureFile"]');
                if (fileInput.files[0]) {
                    data.fileData = await fileToBase64(fileInput.files[0]);
                    data.fileName = fileInput.files[0].name;
                    data.mimeType = fileInput.files[0].type;
                }
                const action = data.CoachID ? 'editCoach' : 'addCoach';
                const result = await apiCall(action, data);
                if (result.success) {
                    alert(result.message);
                    closeModal('coach-form-modal');
                    await fetchData();
                    loadAdminData();
                }
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการส่งข้อมูล: ${error.message}`);
            }
        });
        
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const fileInput = e.target.querySelector('[name="StudentPictureFile"]');
                if (fileInput.files[0]) {
                    data.fileData = await fileToBase64(fileInput.files[0]);
                    data.fileName = fileInput.files[0].name;
                    data.mimeType = fileInput.files[0].type;
                }
                const action = data.StudentID ? 'editStudent' : 'addStudent';
                const result = await apiCall(action, data);
                if (result.success) {
                    alert(result.message);
                    closeModal('student-form-modal');
                    await fetchData();
                    loadAdminData();
                }
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการส่งข้อมูล: ${error.message}`);
            }
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if(newPassword !== confirmPassword) { alert('รหัสผ่านใหม่และการยืนยันไม่ตรงกัน'); return; }
            if(!newPassword || newPassword.length < 4) { alert('รหัสผ่านใหม่ต้องมีอย่างน้อย 4 ตัวอักษร'); return; }
            const result = await apiCall('changePassword', { currentPassword, newPassword });
            alert(result.message);
            if(result.success) {
                ADMIN_PASSWORD = newPassword;
                changePasswordForm.reset();
            }
        });

        promptpayForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const promptpayNumber = document.getElementById('promptpay-number').value;
            const result = await apiCall('updateConfig', { PromptPay: promptpayNumber });
            alert(result.message);
        });
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        fetchData();
    });
</script>
</body>
</html>
